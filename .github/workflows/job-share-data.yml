name: Visual regression

on:
  - push
  - pull_request
  - workflow_dispatch

jobs:
  differentiate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v3
        env:
          cache-name: cache-node-modules
        with:
          # npm cache files are stored in `~/.npm` on Linux/macOS
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-

      - uses: actions/setup-node@v2
        with:
          node-version: 16
      - run: npm ci
      - run: npm run screenshot clocktab-1.png
        name: Take screenshot 1
      - name: Upload screenshot 1
        uses: actions/upload-artifact@v3
        with:
          name: screenshot-1
          path: clocktab-1.png
      - run: npm run screenshot clocktab-2.png
        name: Take screenshot 2
      - name: Upload screenshot 2
        uses: actions/upload-artifact@v3
        with:
          name: screenshot-2
          path: clocktab-2.png
      - name: Diff images
        run: npm run diff clocktab-1.png clocktab-2.png clocktab-diff.png > diff-results.txt
        continue-on-error: true
      - name: Upload diff
        uses: actions/upload-artifact@v3
        with:
          name: screenshot-diff
          path: clocktab-diff.png
      - name: comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          append: true
          number: ${{ github.event.number }}
          path: diff-results.txt
      - name: Pull request artifacts
        if: ${{ github.event_name == 'pull_request' }}
        uses: gavv/pull-request-artifacts@v1.0.0
        with:
          commit: ${{ github.event.pull_request.head.sha }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          artifacts-branch: artifacts
          artifacts: |
            clocktab-1.png
            clocktab-2.png
            clocktab-diff.png
      - name: comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: Diff images
          number: ${{ github.event.number }}
          message: |
            ### Baseline
            [<img alt="baseline" src="https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-1.png?raw=true?raw=true" width="50%"/>](https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-1.png?raw=true)
            ### PR
            [<img alt="baseline" src="https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-2.png?raw=true?raw=true" width="50%"/>](https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-2.png?raw=true)
            ### Diff
            [<img alt="baseline" src="https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-diff.png?raw=true?raw=true" width="50%"/>](https://github.com/${{ github.repository }}/blob/artifacts/pr${{ github.event.number }}-clocktab-diff.png?raw=true)


#  take_screenshot_1:
#    needs: build
#    name: Take Screenshot
#    runs-on: ubuntu-latest
#    steps:
#      - run: npm ci
#      - name: Take screenshot 1
#        run: npm run screenshot clocktab-1.png
#      name: Upload screenshot 1
#        uses: actions/upload-artifact@v3
#        with:
#          name: screenshot-1
#          path: clocktab-1.png

#  job_1:
#    name: Add 3 and 7
#    runs-on: ubuntu-latest
#    steps:
#      - shell: bash
#        run: |
#          expr 3 + 7 > math-homework.txt
#      - name: Upload math result for job 1
#        uses: actions/upload-artifact@v3
#        with:
#          name: homework
#          path: math-homework.txt
#
#  job_2:
#    name: Multiply by 9
#    needs: job_1
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download math result for job 1
#        uses: actions/download-artifact@v3
#        with:
#          name: homework
#      - shell: bash
#        run: |
#          value=`cat math-homework.txt`
#          expr $value \* 9 > math-homework.txt
#      - name: Upload math result for job 2
#        uses: actions/upload-artifact@v3
#        with:
#          name: homework
#          path: math-homework.txt
#
#  job_3:
#    name: Display results
#    needs: job_2
#    runs-on: ubuntu-latest
#    steps:
#      - name: Download math result for job 2
#        uses: actions/download-artifact@v3
#        with:
#          name: homework
#      - name: Print the final result
#        shell: bash
#        run: |
#          value=`cat math-homework.txt`
#          echo The result is $value